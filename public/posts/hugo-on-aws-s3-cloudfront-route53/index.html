<!DOCTYPE html>
<html âš¡ lang="en">
	<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

<title>Hugo on AWS - S3/Cloudfront/Route53</title>
    
<meta name="description" content="" />
<link rel="canonical" href="https://blog.heyitschris.com/posts/hugo-on-aws-s3-cloudfront-route53/" >
<link rel="sitemap" href="https://blog.heyitschris.com/sitemap.xml" type="application/xml" /><meta property="og:title" content="Hugo on AWS - S3/Cloudfront/Route53">
<meta property="og:url" content="https://blog.heyitschris.com/posts/hugo-on-aws-s3-cloudfront-route53/">
<meta property="og:description" content="">
<meta property="og:image" content="https://blog.heyitschris.com/logo.png">
<meta property="og:type" content="article">
<meta property="og:site_name" content=""><meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hugo on AWS - S3/Cloudfront/Route53">
<meta name="twitter:url" content="https://blog.heyitschris.com/posts/hugo-on-aws-s3-cloudfront-route53/">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://blog.heyitschris.com/logo.png">
<meta name="twitter:site" content="@chris_the_nagy"><meta name="theme-color" content="#333"/>
<link rel="manifest" href="https://blog.heyitschris.com/manifest.json">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.heyitschris.com/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.heyitschris.com/icons/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://blog.heyitschris.com/icons/apple-touch-icon.png"><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes  -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript>
    <style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style>
</noscript><style amp-custom>
    
        *,*::before,*::after{box-sizing:border-box}ul[class],ol[class]{padding:0}body,h1,h2,h3,h4,p,ul[class],ol[class],li,figure,figcaption,blockquote,dl,dd{margin:0}body{min-height:100vh;scroll-behavior:smooth;text-rendering:optimizeSpeed}ul[class],ol[class]{list-style:none}a:not([class]){text-decoration-skip-ink:auto}img{max-width:100%;display:block}input,button,textarea,select{font:inherit}.chroma{background-color:#fff}.chroma .err{color:#a61717;background-color:#e3d2d2}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#000;font-weight:700}.chroma .kc{color:#000;font-weight:700}.chroma .kd{color:#000;font-weight:700}.chroma .kn{color:#000;font-weight:700}.chroma .kp{color:#000;font-weight:700}.chroma .kr{color:#000;font-weight:700}.chroma .kt{color:#458;font-weight:700}.chroma .na{color:teal}.chroma .nb{color:#0086b3}.chroma .bp{color:#999}.chroma .nc{color:#458;font-weight:700}.chroma .no{color:teal}.chroma .nd{color:#3c5d5d;font-weight:700}.chroma .ni{color:purple}.chroma .ne{color:#900;font-weight:700}.chroma .nf{color:#900;font-weight:700}.chroma .nl{color:#900;font-weight:700}.chroma .nn{color:#555}.chroma .nt{color:navy}.chroma .nv{color:teal}.chroma .vc{color:teal}.chroma .vg{color:teal}.chroma .vi{color:teal}.chroma .s{color:#d14}.chroma .sa{color:#d14}.chroma .sb{color:#d14}.chroma .sc{color:#d14}.chroma .dl{color:#d14}.chroma .sd{color:#d14}.chroma .s2{color:#d14}.chroma .se{color:#d14}.chroma .sh{color:#d14}.chroma .si{color:#d14}.chroma .sx{color:#d14}.chroma .sr{color:#009926}.chroma .s1{color:#d14}.chroma .ss{color:#990073}.chroma .m{color:#099}.chroma .mb{color:#099}.chroma .mf{color:#099}.chroma .mh{color:#099}.chroma .mi{color:#099}.chroma .il{color:#099}.chroma .mo{color:#099}.chroma .o{color:#000;font-weight:700}.chroma .ow{color:#000;font-weight:700}.chroma .c{color:#998;font-style:italic}.chroma .ch{color:#998;font-style:italic}.chroma .cm{color:#998;font-style:italic}.chroma .c1{color:#998;font-style:italic}.chroma .cs{color:#999;font-weight:700;font-style:italic}.chroma .cp{color:#999;font-weight:700;font-style:italic}.chroma .cpf{color:#999;font-weight:700;font-style:italic}.chroma .gd{color:#000;background-color:#fdd}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#a00}.chroma .gh{color:#999}.chroma .gi{color:#000;background-color:#dfd}.chroma .go{color:#888}.chroma .gp{color:#555}.chroma .gs{font-weight:700}.chroma .gu{color:#aaa}.chroma .gt{color:#a00}.chroma .gl{text-decoration:underline}.chroma .w{color:#bbb}body{max-width:100%;display:grid;grid-template-columns:repeat(12,1fr);grid-gap:1em 1em;font-size:1.2em;font-family:Courier New,sans-serif;line-height:1.6;color:#000}.header,.main,.footer{grid-column:4/span 6}.header{margin-top:1em}.header__menu{margin:0;padding:0;display:flex;overflow:auto;justify-content:flex-start;border:1px solid #333}.header__menu a{font-size:1.2em;white-space:nowrap;border-bottom:none}.header__menu a:hover{color:#d14}.header__menu__logo{line-height:0}.header__menu__logo svg{width:75px;height:75px;min-width:75px;min-height:75px}.header__menu__list{display:flex;flex-grow:1;flex-wrap:nowrap;align-items:center;justify-content:space-around}.header__menu__list li{padding:0 1em;display:inline}.main{min-width:0;min-height:80vh}.main .pagination{margin:3em auto 2em;display:flex;justify-content:space-between}.footer{display:flex;justify-content:space-between;flex-wrap:wrap}h1{font-size:3.5rem}h2{font-size:2.5rem}h3{font-size:2rem}h4{font-size:1.5rem}a{color:inherit;text-decoration:none;transition:background .3s;border-bottom:2px dashed #37474f}a:hover{border-color:#d14}.button{padding:.5em .75em;font-size:1.2em;text-align:center;border:1px solid #000;box-shadow:7px 7px 0 0 #333}.button:hover{color:#d14;border:1px solid #000;transform:translate(4px,4px);box-shadow:3px 3px 0 0 #333}li{margin-top:.25em}pre,code{font-family:lucida console,Monaco,monospace;font-size:12pt;background-color:#f1f1f1}blockquote{margin:inherit auto;margin-left:1em;padding:1em;border-left:5px solid #999}blockquote:before{display:none}blockquote:not(:first-of-type){margin-top:.5em}blockquote p{color:#555;font-size:1.25em;font-family:times new roman,serif}.figure{width:100%;max-width:100%}.figure--with-caption{display:flex;border-top:6px solid #333}.figure__image--with-caption{min-width:70%}.figure__caption{background-color:#333;color:#fff;font-weight:700;padding:.5em 1em;height:min-content;word-wrap:break-word}.post-it{width:100%;padding:1.5em}.post-it--tip{background-color:#fffacd}.post-it--info{background-color:azure}.post-it--danger{background-color:#ffcccb}.post-it--success{background-color:#d0f0c0}.post-it__title{font-weight:700;font-size:1.5em}.post-it__content{margin-top:1em}.product{width:100%;display:flex;justify-content:space-between;padding:1.5em;border:1px solid #333}.product__image{margin:auto;width:100%;min-width:250px;max-width:400px}.product__content{margin-left:2em;align-self:center;display:flex;flex-direction:column}.product__title{font-weight:700;font-size:1.5rem}.product__description{margin-top:1em}.product__cta{margin-top:1em}.social-share{display:flex;align-self:center;align-items:center}.social-share__button{margin:0 .5em;border-radius:50%;background-size:60%}#tags{margin:0;padding:0}#tags li{display:inline}.content{width:100%}.content>*{margin-top:1.5em}.content>h1{margin-top:.5em}.content pre{overflow:auto;padding:.5em}.content code{padding:.1em}.content table{display:block;overflow-x:auto;border-collapse:collapse}.content table td,.content table th{border:1px solid #ddd}.content table td{padding:.5em 1em}.content table th{padding:1em 2em;background-color:#333;color:#fff}.content table tr:nth-child(even){background-color:#f1f1f1}.content table tr:hover{background-color:#ddd}.content .highlight .chroma{background-color:#f1f1f1}.content .under-title{display:flex;flex-wrap:wrap;justify-content:space-between;font-size:1rem}.content .under-title__info,.content .under-title__social-share{align-self:center}.content .ad{display:flex;margin:1rem auto;align-content:center;width:min-content;height:min-content;min-width:320px;min-height:320px;border:1px solid #333}.content .ad__fallback{display:flex;align-items:center}.content .ad__fallback p{margin:auto}.content .author{display:flex;flex-direction:column;align-items:center;background-color:#f1f1f1;padding:1.5rem}.content .author>*:not(:first-child){margin-top:1rem}.content .author__name{font-weight:700;font-size:1.5em}.content .author__image{border-radius:100px}.content .author__bio,.content .author__cta{text-align:center}.content .author__cta{font-size:1.25em}.summary:not(:first-of-type) h2{margin-top:2.5em}.summary>*{margin-top:1.25em}.summary__title{text-align:center}.summary .button{display:block;margin:inherit 1em}@media(max-width:1200px){body{grid-gap:0}.main,.header,.footer{grid-column:1/span 12}.main,.footer{margin:1em .75em 0 .5em}.header{margin:0}.header__menu{border:none;border-bottom:1px solid #333}h1{font-size:2.5rem}h2{font-size:2rem}h3{font-size:1.66rem}h4{font-size:1.25rem}.post-it{margin-left:0;margin-right:0}}@media(max-width:600px){.under-title__social-share{width:100%;margin-top:1.5em;justify-content:space-between}.figure{flex-direction:column-reverse}.figure--with-caption{border-top:none}.figure__caption{position:relative;max-width:100%}.product{flex-wrap:wrap}.product__content{margin-left:unset;text-align:center}.product__title{margin-top:1em}}
    
    
</style><script async src="https://cdn.ampproject.org/v0.js"></script><script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script><script async custom-element="amp-social-share" src="https://cdn.ampproject.org/v0/amp-social-share-0.1.js"></script><script async custom-element="amp-install-serviceworker" src="https://cdn.ampproject.org/v0/amp-install-serviceworker-0.1.js"></script><script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>

</head>
	<body><amp-install-serviceworker
  src="https://blog.heyitschris.com/sw.js"
  data-iframe-src="https://blog.heyitschris.com/install-sw.html"
  layout="nodisplay">
</amp-install-serviceworker>




  
  
  

  
  
  
    
  

  
  
  
    
  

  
  
  


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      
        
        {
          "@type": "ListItem",
          "position":  1 ,
          "item": {
            "@id": "https:\/\/blog.heyitschris.com",
            "name": "Home"
          }
        }
      
        ,
        {
          "@type": "ListItem",
          "position":  2 ,
          "item": {
            "@id": "https:\/\/blog.heyitschris.com\/posts\/",
            "name": "Posts"
          }
        }
      
        ,
        {
          "@type": "ListItem",
          "position":  3 ,
          "item": {
            "@id": "https:\/\/blog.heyitschris.com\/posts\/hugo-on-aws-s3-cloudfront-route53\/",
            "name": "Hugo on aws s3 cloudfront route53"
          }
        }
       ]
  }
</script><script type="application/ld+json">
  {
    "@context":"http://schema.org",
    "@type": "BlogPosting",
    "image": "https:\/\/blog.heyitschris.com",
    "url": "https:\/\/blog.heyitschris.com\/posts\/hugo-on-aws-s3-cloudfront-route53\/",
    "headline": "Hugo on AWS - S3\/Cloudfront\/Route53",
    "alternativeHeadline": "Hugo on AWS - S3\/Cloudfront\/Route53",
    "dateCreated": "2020-06-28T13:45:24",
    "datePublished": "2020-06-28T13:45:24",
    "dateModified": "2020-06-28T13:45:24",
    "inLanguage": "en",
    "isFamilyFriendly": "true",
    "copyrightYear": "2020",
    "copyrightHolder": "",
    "accountablePerson": {
      "@type": "Person",
      "name": "",
      "url": ""
    },
    "author": {
      "@type": "Person",
      "name": "",
      "url": "https:\/\/blog.heyitschris.com",
      "image": "https:\/\/blog.heyitschris.com",
      "description": ""
    },
    "creator": {
      "@type": "Person",
      "name": "",
      "url": "https:\/\/blog.heyitschris.com",
      "image": "https:\/\/blog.heyitschris.com",
      "description": ""
    },
    "publisher": {
      "@type": "Organization",
      "name": "Hey, it\u0027s Chris",
      "url": "https:\/\/blog.heyitschris.com",
      "logo": {
        "@type": "ImageObject",
        "url": "\/",
        "width":"600",
        "height":"60"
      }
    },
    "mainEntityOfPage": "https:\/\/blog.heyitschris.com\/posts\/hugo-on-aws-s3-cloudfront-route53\/",
    "keywords": "null",
    "genre": "null",
    "articleSection": "Posts"
  }
</script><header class="header"><nav class="header__menu">
    <a class="header__menu__logo" data-rel="prefetch" href="https://blog.heyitschris.com" aria-label="Go back to the homepage"></a>
<ul class="header__menu__list">
    
    
        
        <li>
            <a href="https://blog.heyitschris.com"
                 data-rel="prefetch"
                >
                <span>Home</span>
            </a>
        </li>
    
        
        <li>
            <a href="https://blog.heyitschris.com/about"
                 data-rel="prefetch"
                >
                <span>About</span>
            </a>
        </li>
    
        
        <li>
            <a href="https://github.com/what-name"
                 target="_blank" rel="nofollow noopener noreferrer" >
                <span>GitHub</span>
            </a>
        </li>
    
        
        <li>
            <a href="https://heyitschris.com"
                 target="_blank" rel="nofollow noopener noreferrer" >
                <span>Resume</span>
            </a>
        </li>
    
        
        <li>
            <a href="https://twitter.com/chris_the_nagy"
                 target="_blank" rel="nofollow noopener noreferrer" >
                <span>Twitter</span>
            </a>
        </li>
    
</ul></nav></header>
		<main class="main">
	<article class="content">
		<h2 id="how-to-host-a-hugo-static-site-on-aws-serverless-with-cloudformation">How to host a Hugo static site on AWS Serverless with CloudFormation.</h2>
<p>I built this blog with Hugo and wanted to host it on my already existing AWS S3 static site infrastructure. The problem was however that the main page loaded no problem, but anything in <code>/posts/this-post</code> would get an <code>AccessDenied</code> error. While I haven&rsquo;t figured out <em>why</em> this problem exists, I did make it work and now I&rsquo;m sharing the setup here since there is no clear-cut guide on Hugo for this setup.</p>
<h4 id="notes">Notes</h4>
<p>You can not use an <code>OAI</code> with Hugo. You need to use the <strong>Endpoint URL</strong> of the S3 bucket as the origin for your CloudFront distribution. An endpoint URL looks like this: <code>myblogbucket.s3-website-us-east-1.amazonaws.com</code>. Notice the region, this is the endpoint URL of your bucket, and you can get this from the <code>Properties-&gt;Static Website Hosting</code> submenu in the console inside the origin bucket.</p>
<h3 id="the-resources">The resources</h3>
<p>Here are the most important resources and their properties with a YAML CloudFormation template.</p>
<h4 id="the-blog-bucket-itself">The blog bucket itself</h4>
<p>I added the CORS configuration, you might not need it. <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html">See AWS CloudFormation S3 reference</a>
<pre><code class="language-linenos=table" data-lang="linenos=table">BlogWebsiteBucket:
  Type: AWS::S3::Bucket
  Properties:
    BucketName: &#34;mywebsite-blog&#34;
    WebsiteConfiguration:
      IndexDocument: index.html
    CorsConfiguration:
      CorsRules:
        - 
          AllowedMethods: 
            - GET
            - HEAD
          AllowedOrigins: 
            - &#34;*&#34;
          AllowedHeaders: 
            - &#34;*&#34;</code></pre></p>
<h4 id="the-blog-bucket-policy">The blog bucket policy</h4>
<p>As I said you <strong>can not use an OAI</strong> with your CloudFront distribution here because you need the endpoint URL of the bucket for Hugo to be able to do its job. For this reason, you need to give public read access to the bucket. While this is not a perfect solution, it&rsquo;s the one that worked for me and I&rsquo;m willing to sacrifice this much security. (if you know a better way of doing this, please hit me up on <a href="https://twitter.com/chris_the_nagy">Twitter</a>) <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-policy.html">See AWS CloudFormation S3 bucket policy reference</a>
<pre><code class="language-linenos=table" data-lang="linenos=table">BlogWebsiteBucketBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      PolicyDocument:
        Id: PublicAccessPolicy
        Version: 2012-10-17
        Statement:
          - Sid: PublicReadForGetBucketObjects
            Effect: Allow
            Principal: &#34;*&#34;
            Action: s3:GetObject
            Resource: !Sub &#34;arn:aws:s3:::${BlogWebsiteBucket}/*&#34;
      Bucket: !Ref BlogWebsiteBucket</code></pre></p>
<h4 id="the-cloudfront-distribution">The CloudFront distribution</h4>
<p>This is the most important part and I spent most of the troubleshooting time on this. The important part here is that we&rsquo;re not using an <code>S3Origin</code> but a <code>CustomOriginConfig</code> pointing to the endpoint URL of the S3 bucket. It&rsquo;s important to set the <code>DefaultRootObject: index.html</code> on both the distribution and the origin S3 bucket, otherwise your browser will try to <em>list</em> the contents of your bucket (and prefix) instead of serving you the page. <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudfront-distribution.html">See AWS CloudFormation CloudFront reference</a>
<pre><code class="language-linenos=table" data-lang="linenos=table">BlogCloudFrontDistribution:
  Type: AWS::CloudFront::Distribution
  Properties:
    DistributionConfig:
      Origins:
      - Id: !Sub &#34;${BlogWebsiteBucket}-origin&#34;
        CustomOriginConfig: 
          OriginProtocolPolicy: http-only
          HTTPPort: 80
          OriginSSLProtocols: 
            - TLSv1
            - TLSv1.1
            - TLSv1.2
          HTTPSPort: 443
        DomainName: !Sub &#34;${BlogWebsiteBucket}.s3-website-${AWS::Region}.amazonaws.com&#34;
      Enabled: true
      Comment: Static blog website distribution
      DefaultRootObject: index.html
      Aliases:
        - blog.yourwebsite.com # Change this to your domain!
      DefaultCacheBehavior:
        DefaultTTL: 1800
        MaxTTL: 14400
        Compress: true
        AllowedMethods:
          - HEAD
          - GET
        CachedMethods:
          - HEAD
          - GET
        TargetOriginId: !Sub &#34;${BlogWebsiteBucket}-origin&#34;
        ForwardedValues:
          QueryString: &#39;false&#39;
        ViewerProtocolPolicy: redirect-to-https
      PriceClass: PriceClass_100
      ViewerCertificate:
        AcmCertificateArn: !Ref DomainCertificate
        SslSupportMethod: sni-only</code></pre></p>
<h4 id="the-route53-entry">The Route53 Entry.</h4>
<p>Pay attention to the <code>HostedZoneId</code> of the <code>AliasTarget</code>! Took me a while to figure out that <strong>all</strong> CloudFront distributions live in the same hosted zone <code>Z2FDTNDATAQYW2</code>. <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-recordset.html">See AWS CloudFormation Route53 RecordSet reference</a>
<pre><code class="language-linenos=table" data-lang="linenos=table"> DNSRecordBlog:
    Type: AWS::Route53::RecordSet
    Properties:
      Name: !Sub &#34;blog.${WebsiteDomainName}&#34;
      Type: A
      # Refers to the HostedZone resource that I didn&#39;t include here
      HostedZoneId: !Ref HostedZone
      AliasTarget:
        DNSName: !GetAtt BlogCloudFrontDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2</code></pre></p>
<h4 id="acm-cert">ACM Cert</h4>
<p>And finally a little extra, the ACM certificate for both the main <code>mydomain.com</code> and the wildcard <code>*.mydomain.com</code>. The little <em>gotcha</em> here is that the main cert is the wildcard, and the main domain is only an alternative name. <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-certificatemanager-certificate.html">See AWS CloudFormation Certificate Manager reference.</a></p>
<p>ðŸš¨Important to remember here that your CloudFormation stack will not proceed until you verify your domain via the email ACM sends to the adress that&rsquo;s registered with the domain!</p>
<pre><code class="language-linenos=table" data-lang="linenos=table">DomainCertificate:
  Type: AWS::CertificateManager::Certificate
  Properties:
    DomainName: !Sub &#34;*.${WebsiteDomainName}&#34;
    SubjectAlternativeNames:
      - !Ref WebsiteDomainName
      - !Sub &#34;*.${WebsiteDomainName}&#34;
    DomainValidationOptions:
      - DomainName: !Ref WebsiteDomainName
        ValidationDomain: !Ref WebsiteDomainName
    ValidationMethod: EMAIL</code></pre>
<h3 id="closing-thoughts">Closing Thoughts</h3>
<p>I like <a href="https://gohugo.io/">Hugo</a> a lot. It&rsquo;s a very easy and developer friendly way of creating and updating static sites and blogs. This setup is not the &ldquo;usual&rdquo; way of hosting a Hugo site but it is an option and works well in my opinion while maintaining ultra low cost (my whole website costs me less than 5 cents a month).</p>
<p>If you have any thoughts, questions or recommendations, hit me up on <a href="https://twitter.com/chris_the_nagy">Twitter</a> or at <a href="mailto:contact@heyitschris.com">contact@heyitschris.com</a>.</p>
<p><em>This post was written on 28th of June 2020.</em></p>

</article>

		</main>
		<footer class="footer"><div class="footer__copyright">Â© Chris Nagy 2020</div><div class="footer__languages">
	
</div></footer>
	</body>
</html>
